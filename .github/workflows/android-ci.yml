name: Android CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run dependency check weekly on Sundays at 6:00 AM UTC
    - cron: '0 6 * * 0'
  workflow_dispatch:
    # Allow manual trigger for dependency updates

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Setup Google Services JSON
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          if [ -n "$GOOGLE_SERVICES_JSON" ]; then
            echo "$GOOGLE_SERVICES_JSON" | base64 --decode > app/google-services.json
            echo "google-services.json decoded from secret"
          else
            # Create dummy for debug builds
            echo '{"project_info":{"project_number":"000000000000","project_id":"dummy","storage_bucket":"dummy.appspot.com"},"client":[{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000000000000","android_client_info":{"package_name":"com.paperless.scanner"}},"api_key":[{"current_key":"dummy"}]},{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000000000001","android_client_info":{"package_name":"com.paperless.scanner.debug"}},"api_key":[{"current_key":"dummy"}]}],"configuration_version":"1"}' > app/google-services.json
            echo "::warning::Using dummy google-services.json for CI"
          fi

      - name: Run unit tests
        run: ./gradlew testReleaseUnitTest

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results
          path: app/build/reports/tests/
          retention-days: 7

      - name: Build debug APK
        run: ./gradlew assembleDebug

      - name: Upload debug APK
        uses: actions/upload-artifact@v6
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 14

  lint:
    name: Lint Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Setup Google Services JSON
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          if [ -n "$GOOGLE_SERVICES_JSON" ]; then
            echo "$GOOGLE_SERVICES_JSON" | base64 --decode > app/google-services.json
          else
            echo '{"project_info":{"project_number":"000000000000","project_id":"dummy","storage_bucket":"dummy.appspot.com"},"client":[{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000000000000","android_client_info":{"package_name":"com.paperless.scanner"}},"api_key":[{"current_key":"dummy"}]},{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000000000001","android_client_info":{"package_name":"com.paperless.scanner.debug"}},"api_key":[{"current_key":"dummy"}]}],"configuration_version":"1"}' > app/google-services.json
          fi

      - name: Run lint
        run: ./gradlew lintRelease

      - name: Upload lint results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: lint-results
          path: app/build/reports/lint-results-release.html
          retention-days: 7

  validate:
    name: Validation Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Grant execute permission for scripts
        run: chmod +x scripts/*.sh

      - name: Check translation completeness
        run: ./scripts/check-translations.sh

      - name: Check for hardcoded strings in Kotlin
        run: |
          echo "Checking for potential hardcoded strings..."
          # Find text="" attributes in Composables that should use stringResource
          HARDCODED=$(grep -rn 'text = "' app/src/main/java --include="*.kt" | grep -v "// OK" | grep -v "TODO" | head -20 || true)
          if [ -n "$HARDCODED" ]; then
            echo "⚠️ Potential hardcoded strings found (review manually):"
            echo "$HARDCODED"
            echo ""
            echo "Consider using stringResource(R.string.xxx) instead."
          else
            echo "✓ No obvious hardcoded strings found"
          fi

      - name: Validate XML resources
        run: |
          echo "Validating XML resources..."
          # Check for duplicate string IDs in base strings.xml
          DUPLICATES=$(grep '<string name="' app/src/main/res/values/strings.xml | sed 's/.*name="\([^"]*\)".*/\1/' | sort | uniq -d)
          if [ -n "$DUPLICATES" ]; then
            echo "❌ Duplicate string IDs found:"
            echo "$DUPLICATES"
            exit 1
          else
            echo "✓ No duplicate string IDs"
          fi

          # Check for empty strings
          EMPTY=$(grep '<string name="[^"]*"></string>' app/src/main/res/values/strings.xml || true)
          if [ -n "$EMPTY" ]; then
            echo "⚠️ Empty strings found:"
            echo "$EMPTY"
          else
            echo "✓ No empty strings"
          fi

  code-quality:
    name: Code Quality (Detekt + KtLint)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Detekt
        run: ./gradlew detekt --continue || true

      - name: Upload Detekt results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: detekt-results
          path: app/build/reports/detekt/
          retention-days: 7

      - name: Run KtLint
        run: ./gradlew ktlintCheck --continue || true

      - name: Upload KtLint results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: ktlint-results
          path: app/build/reports/ktlint/
          retention-days: 7

  screenshot-tests:
    name: Screenshot Tests (Paparazzi)
    runs-on: ubuntu-latest
    # Only run on manual trigger
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Paparazzi screenshot tests
        run: ./gradlew verifyPaparazziDebug --continue || true

      - name: Upload screenshot test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: screenshot-test-results
          path: app/build/reports/paparazzi/
          retention-days: 14

  dependency-updates:
    name: Dependency Updates Check
    runs-on: ubuntu-latest
    # Only run on schedule or manual trigger, not on every push
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Check for dependency updates
        run: ./gradlew dependencyUpdates

      - name: Upload dependency report
        uses: actions/upload-artifact@v6
        with:
          name: dependency-updates-report
          path: build/reports/dependencyUpdates/
          retention-days: 30
