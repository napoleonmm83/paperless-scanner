name: Android CI

on:
  push:
    branches: [ main, develop ]
    paths:
      # Only run CI when app-relevant files change
      - 'app/**'
      - 'gradle/**'
      - '*.gradle'
      - '*.gradle.kts'
      - 'gradle.properties'
      - 'version.properties'
      - 'gradlew'
      - 'gradlew.bat'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      # Only run CI when app-relevant files change
      - 'app/**'
      - 'gradle/**'
      - '*.gradle'
      - '*.gradle.kts'
      - 'gradle.properties'
      - 'version.properties'
      - 'gradlew'
      - 'gradlew.bat'
      - '.github/workflows/**'
  schedule:
    # Run dependency check weekly on Sundays at 6:00 AM UTC
    - cron: '0 6 * * 0'
  workflow_dispatch:
    # Allow manual trigger for dependency updates

# Required permissions for querying runners API
permissions:
  contents: read
  actions: read

jobs:
  # Check if self-hosted runner is available
  check-runner:
    name: Check Runner Availability
    runs-on: ubuntu-latest
    outputs:
      runner: ${{ steps.check.outputs.runner }}
      is-self-hosted: ${{ steps.check.outputs.is-self-hosted }}
    steps:
      - name: Check for self-hosted runner
        id: check
        env:
          GH_TOKEN: ${{ secrets.RUNNER_CHECK_TOKEN || github.token }}
        run: |
          # Query GitHub API for online self-hosted runners
          # Note: Requires PAT with 'repo' scope stored as RUNNER_CHECK_TOKEN secret
          # or repository admin access for GITHUB_TOKEN
          RESPONSE=$(gh api repos/${{ github.repository }}/actions/runners 2>&1) || RESPONSE='{"runners":[]}'

          echo "API Response: $RESPONSE"

          # Check for Windows runner (Priority 1)
          WINDOWS_ONLINE=$(echo "$RESPONSE" | jq -r '.runners // [] | map(select(.status == "online" and (.labels | map(.name) | contains(["paperlesswin"])))) | length' 2>/dev/null || echo "0")

          # Check for Mac runner (Priority 2)
          MAC_ONLINE=$(echo "$RESPONSE" | jq -r '.runners // [] | map(select(.status == "online" and (.labels | map(.name) | contains(["paperless"])) and (.labels | map(.name) | contains(["macOS"])))) | length' 2>/dev/null || echo "0")

          echo "Windows runners online: $WINDOWS_ONLINE"
          echo "Mac runners online: $MAC_ONLINE"

          if [ "$WINDOWS_ONLINE" -gt 0 ]; then
            echo "✅ Windows runner available - using it (Priority 1)"
            echo 'runner=["self-hosted", "paperlesswin"]' >> $GITHUB_OUTPUT
            echo 'is-self-hosted=true' >> $GITHUB_OUTPUT
          elif [ "$MAC_ONLINE" -gt 0 ]; then
            echo "✅ Mac runner available - using it (Priority 2)"
            echo 'runner=["self-hosted", "paperless"]' >> $GITHUB_OUTPUT
            echo 'is-self-hosted=true' >> $GITHUB_OUTPUT
          else
            echo "⚠️ No self-hosted runner available - falling back to ubuntu-latest"
            echo 'runner=["ubuntu-latest"]' >> $GITHUB_OUTPUT
            echo 'is-self-hosted=false' >> $GITHUB_OUTPUT
          fi

  build:
    name: Build & Test
    needs: check-runner
    runs-on: ${{ fromJSON(needs.check-runner.outputs.runner) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK path (self-hosted macOS)
        if: needs.check-runner.outputs.is-self-hosted == 'true' && runner.os == 'macOS'
        run: |
          echo "Setting up Android SDK for self-hosted macOS runner..."
          ANDROID_SDK="$HOME/Library/Android/sdk"
          if [ -d "$ANDROID_SDK" ]; then
            echo "ANDROID_HOME=$ANDROID_SDK" >> $GITHUB_ENV
            echo "ANDROID_SDK_ROOT=$ANDROID_SDK" >> $GITHUB_ENV
            echo "$ANDROID_SDK/platform-tools" >> $GITHUB_PATH
            echo "$ANDROID_SDK/cmdline-tools/latest/bin" >> $GITHUB_PATH
            echo "✅ Android SDK found at: $ANDROID_SDK"
          else
            echo "❌ Android SDK not found at: $ANDROID_SDK"
            exit 1
          fi
        shell: bash

      - name: Setup Android SDK path (self-hosted Windows)
        if: needs.check-runner.outputs.is-self-hosted == 'true' && runner.os == 'Windows'
        run: |
          echo "Setting up Android SDK for self-hosted Windows runner..."
          $ANDROID_SDK = "$env:LOCALAPPDATA\Android\Sdk"
          if (Test-Path $ANDROID_SDK) {
            echo "ANDROID_HOME=$ANDROID_SDK" >> $env:GITHUB_ENV
            echo "ANDROID_SDK_ROOT=$ANDROID_SDK" >> $env:GITHUB_ENV
            echo "$ANDROID_SDK\platform-tools" >> $env:GITHUB_PATH
            echo "$ANDROID_SDK\cmdline-tools\latest\bin" >> $env:GITHUB_PATH
            echo "✅ Android SDK found at: $ANDROID_SDK"
          } else {
            echo "❌ Android SDK not found at: $ANDROID_SDK"
            exit 1
          }
        shell: powershell

      - name: Grant execute permission for gradlew
        if: runner.os != 'Windows'
        run: chmod +x gradlew
        shell: bash

      - name: Setup Google Services JSON (Linux/macOS)
        if: runner.os != 'Windows'
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        shell: bash
        run: |
          if [ -n "$GOOGLE_SERVICES_JSON" ]; then
            echo "$GOOGLE_SERVICES_JSON" | base64 --decode > app/google-services.json
            echo "google-services.json decoded from secret"
          else
            # Create dummy for debug builds
            echo '{"project_info":{"project_number":"000000000000","project_id":"dummy","storage_bucket":"dummy.appspot.com"},"client":[{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000000000000","android_client_info":{"package_name":"com.paperless.scanner"}},"api_key":[{"current_key":"dummy"}]},{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000000000001","android_client_info":{"package_name":"com.paperless.scanner.debug"}},"api_key":[{"current_key":"dummy"}]}],"configuration_version":"1"}' > app/google-services.json
            echo "::warning::Using dummy google-services.json for CI"
          fi

      - name: Setup Google Services JSON (Windows)
        if: runner.os == 'Windows'
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        shell: powershell
        run: |
          if ($env:GOOGLE_SERVICES_JSON) {
            [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($env:GOOGLE_SERVICES_JSON)) | Out-File -FilePath app/google-services.json -Encoding UTF8
            Write-Host "google-services.json decoded from secret"
          } else {
            '{"project_info":{"project_number":"000000000000","project_id":"dummy","storage_bucket":"dummy.appspot.com"},"client":[{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000000000000","android_client_info":{"package_name":"com.paperless.scanner"}},"api_key":[{"current_key":"dummy"}]},{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000000000001","android_client_info":{"package_name":"com.paperless.scanner.debug"}},"api_key":[{"current_key":"dummy"}]}],"configuration_version":"1"}' | Out-File -FilePath app/google-services.json -Encoding UTF8
            Write-Host "::warning::Using dummy google-services.json for CI"
          }

      - name: Run unit tests (Windows)
        if: runner.os == 'Windows'
        run: gradlew.bat testReleaseUnitTest --no-daemon
        shell: cmd

      - name: Run unit tests (Linux/macOS)
        if: runner.os != 'Windows'
        run: ./gradlew testReleaseUnitTest
        shell: bash

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: app/build/reports/tests/
          retention-days: 7

      - name: Build release APK (Windows)
        if: runner.os == 'Windows'
        run: gradlew.bat assembleRelease --no-daemon
        shell: cmd

      - name: Build release APK (Linux/macOS)
        if: runner.os != 'Windows'
        run: ./gradlew assembleRelease
        shell: bash

      - name: Upload release APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: app/build/outputs/apk/release/app-release.apk
          retention-days: 14

      - name: Show runner info (Windows)
        if: runner.os == 'Windows'
        run: |
          "## Runner Information" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "- **Runner:** ${{ runner.name }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "- **OS:** ${{ runner.os }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "- **Self-hosted:** ${{ needs.check-runner.outputs.is-self-hosted }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
        shell: powershell

      - name: Show runner info (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          echo "## Runner Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner:** ${{ runner.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **OS:** ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Self-hosted:** ${{ needs.check-runner.outputs.is-self-hosted }}" >> $GITHUB_STEP_SUMMARY
        shell: bash

  lint:
    name: Lint Check
    needs: check-runner
    runs-on: ${{ fromJSON(needs.check-runner.outputs.runner) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK path (self-hosted macOS)
        if: needs.check-runner.outputs.is-self-hosted == 'true' && runner.os == 'macOS'
        run: |
          echo "Setting up Android SDK for self-hosted macOS runner..."
          ANDROID_SDK="$HOME/Library/Android/sdk"
          if [ -d "$ANDROID_SDK" ]; then
            echo "ANDROID_HOME=$ANDROID_SDK" >> $GITHUB_ENV
            echo "ANDROID_SDK_ROOT=$ANDROID_SDK" >> $GITHUB_ENV
            echo "$ANDROID_SDK/platform-tools" >> $GITHUB_PATH
            echo "$ANDROID_SDK/cmdline-tools/latest/bin" >> $GITHUB_PATH
            echo "✅ Android SDK found at: $ANDROID_SDK"
          else
            echo "❌ Android SDK not found at: $ANDROID_SDK"
            exit 1
          fi
        shell: bash

      - name: Setup Android SDK path (self-hosted Windows)
        if: needs.check-runner.outputs.is-self-hosted == 'true' && runner.os == 'Windows'
        run: |
          echo "Setting up Android SDK for self-hosted Windows runner..."
          $ANDROID_SDK = "$env:LOCALAPPDATA\Android\Sdk"
          if (Test-Path $ANDROID_SDK) {
            echo "ANDROID_HOME=$ANDROID_SDK" >> $env:GITHUB_ENV
            echo "ANDROID_SDK_ROOT=$ANDROID_SDK" >> $env:GITHUB_ENV
            echo "$ANDROID_SDK\platform-tools" >> $env:GITHUB_PATH
            echo "$ANDROID_SDK\cmdline-tools\latest\bin" >> $env:GITHUB_PATH
            echo "✅ Android SDK found at: $ANDROID_SDK"
          } else {
            echo "❌ Android SDK not found at: $ANDROID_SDK"
            exit 1
          }
        shell: powershell

      - name: Grant execute permission for gradlew
        if: runner.os != 'Windows'
        run: chmod +x gradlew
        shell: bash

      - name: Setup Google Services JSON (Linux/macOS)
        if: runner.os != 'Windows'
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        shell: bash
        run: |
          if [ -n "$GOOGLE_SERVICES_JSON" ]; then
            echo "$GOOGLE_SERVICES_JSON" | base64 --decode > app/google-services.json
          else
            echo '{"project_info":{"project_number":"000000000000","project_id":"dummy","storage_bucket":"dummy.appspot.com"},"client":[{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000000000000","android_client_info":{"package_name":"com.paperless.scanner"}},"api_key":[{"current_key":"dummy"}]},{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000000000001","android_client_info":{"package_name":"com.paperless.scanner.debug"}},"api_key":[{"current_key":"dummy"}]}],"configuration_version":"1"}' > app/google-services.json
          fi

      - name: Setup Google Services JSON (Windows)
        if: runner.os == 'Windows'
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        shell: powershell
        run: |
          if ($env:GOOGLE_SERVICES_JSON) {
            [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($env:GOOGLE_SERVICES_JSON)) | Out-File -FilePath app/google-services.json -Encoding UTF8
            Write-Host "google-services.json decoded from secret"
          } else {
            '{"project_info":{"project_number":"000000000000","project_id":"dummy","storage_bucket":"dummy.appspot.com"},"client":[{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000000000000","android_client_info":{"package_name":"com.paperless.scanner"}},"api_key":[{"current_key":"dummy"}]},{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000000000001","android_client_info":{"package_name":"com.paperless.scanner.debug"}},"api_key":[{"current_key":"dummy"}]}],"configuration_version":"1"}' | Out-File -FilePath app/google-services.json -Encoding UTF8
            Write-Host "::warning::Using dummy google-services.json for CI"
          }

      - name: Run lint (Windows)
        if: runner.os == 'Windows'
        run: gradlew.bat lintRelease --no-daemon
        shell: cmd

      - name: Run lint (Linux/macOS)
        if: runner.os != 'Windows'
        run: ./gradlew lintRelease
        shell: bash

      - name: Upload lint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-results
          path: app/build/reports/lint-results-release.html
          retention-days: 7

  validate:
    name: Validation Checks
    runs-on: ubuntu-latest  # Lightweight - always use GitHub runner

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Grant execute permission for scripts
        run: chmod +x scripts/*.sh

      - name: Check translation completeness
        run: ./scripts/check-translations.sh

      - name: Check for hardcoded strings in Kotlin
        run: |
          echo "Checking for potential hardcoded strings..."
          # Find text="" attributes in Composables that should use stringResource
          HARDCODED=$(grep -rn 'text = "' app/src/main/java --include="*.kt" | grep -v "// OK" | grep -v "TODO" | head -20 || true)
          if [ -n "$HARDCODED" ]; then
            echo "⚠️ Potential hardcoded strings found (review manually):"
            echo "$HARDCODED"
            echo ""
            echo "Consider using stringResource(R.string.xxx) instead."
          else
            echo "✓ No obvious hardcoded strings found"
          fi

      - name: Validate XML resources
        run: |
          echo "Validating XML resources..."
          # Check for duplicate string IDs in base strings.xml
          DUPLICATES=$(grep '<string name="' app/src/main/res/values/strings.xml | sed 's/.*name="\([^"]*\)".*/\1/' | sort | uniq -d)
          if [ -n "$DUPLICATES" ]; then
            echo "❌ Duplicate string IDs found:"
            echo "$DUPLICATES"
            exit 1
          else
            echo "✓ No duplicate string IDs"
          fi

          # Check for empty strings
          EMPTY=$(grep '<string name="[^"]*"></string>' app/src/main/res/values/strings.xml || true)
          if [ -n "$EMPTY" ]; then
            echo "⚠️ Empty strings found:"
            echo "$EMPTY"
          else
            echo "✓ No empty strings"
          fi

  code-quality:
    name: Code Quality (Detekt + KtLint)
    needs: check-runner
    runs-on: ${{ fromJSON(needs.check-runner.outputs.runner) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK path (self-hosted macOS)
        if: needs.check-runner.outputs.is-self-hosted == 'true' && runner.os == 'macOS'
        run: |
          echo "Setting up Android SDK for self-hosted macOS runner..."
          ANDROID_SDK="$HOME/Library/Android/sdk"
          if [ -d "$ANDROID_SDK" ]; then
            echo "ANDROID_HOME=$ANDROID_SDK" >> $GITHUB_ENV
            echo "ANDROID_SDK_ROOT=$ANDROID_SDK" >> $GITHUB_ENV
            echo "$ANDROID_SDK/platform-tools" >> $GITHUB_PATH
            echo "$ANDROID_SDK/cmdline-tools/latest/bin" >> $GITHUB_PATH
            echo "✅ Android SDK found at: $ANDROID_SDK"
          else
            echo "❌ Android SDK not found at: $ANDROID_SDK"
            exit 1
          fi
        shell: bash

      - name: Setup Android SDK path (self-hosted Windows)
        if: needs.check-runner.outputs.is-self-hosted == 'true' && runner.os == 'Windows'
        run: |
          echo "Setting up Android SDK for self-hosted Windows runner..."
          $ANDROID_SDK = "$env:LOCALAPPDATA\Android\Sdk"
          if (Test-Path $ANDROID_SDK) {
            echo "ANDROID_HOME=$ANDROID_SDK" >> $env:GITHUB_ENV
            echo "ANDROID_SDK_ROOT=$ANDROID_SDK" >> $env:GITHUB_ENV
            echo "$ANDROID_SDK\platform-tools" >> $env:GITHUB_PATH
            echo "$ANDROID_SDK\cmdline-tools\latest\bin" >> $env:GITHUB_PATH
            echo "✅ Android SDK found at: $ANDROID_SDK"
          } else {
            echo "❌ Android SDK not found at: $ANDROID_SDK"
            exit 1
          }
        shell: powershell

      - name: Grant execute permission for gradlew
        if: runner.os != 'Windows'
        run: chmod +x gradlew
        shell: bash

      - name: Run Detekt (Windows)
        if: runner.os == 'Windows'
        run: gradlew.bat detekt --continue --no-daemon || exit 0
        shell: cmd

      - name: Run Detekt (Linux/macOS)
        if: runner.os != 'Windows'
        run: ./gradlew detekt --continue || true
        shell: bash

      - name: Upload Detekt results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: detekt-results
          path: app/build/reports/detekt/
          retention-days: 7

      - name: Run KtLint (Windows)
        if: runner.os == 'Windows'
        run: gradlew.bat ktlintCheck --continue --no-daemon || exit 0
        shell: cmd

      - name: Run KtLint (Linux/macOS)
        if: runner.os != 'Windows'
        run: ./gradlew ktlintCheck --continue || true
        shell: bash

      - name: Upload KtLint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ktlint-results
          path: app/build/reports/ktlint/
          retention-days: 7

  screenshot-tests:
    name: Screenshot Tests (Paparazzi)
    needs: check-runner
    runs-on: ${{ fromJSON(needs.check-runner.outputs.runner) }}
    # Only run on manual trigger
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK path (self-hosted macOS)
        if: needs.check-runner.outputs.is-self-hosted == 'true' && runner.os == 'macOS'
        run: |
          echo "Setting up Android SDK for self-hosted macOS runner..."
          ANDROID_SDK="$HOME/Library/Android/sdk"
          if [ -d "$ANDROID_SDK" ]; then
            echo "ANDROID_HOME=$ANDROID_SDK" >> $GITHUB_ENV
            echo "ANDROID_SDK_ROOT=$ANDROID_SDK" >> $GITHUB_ENV
            echo "$ANDROID_SDK/platform-tools" >> $GITHUB_PATH
            echo "$ANDROID_SDK/cmdline-tools/latest/bin" >> $GITHUB_PATH
            echo "✅ Android SDK found at: $ANDROID_SDK"
          else
            echo "❌ Android SDK not found at: $ANDROID_SDK"
            exit 1
          fi
        shell: bash

      - name: Setup Android SDK path (self-hosted Windows)
        if: needs.check-runner.outputs.is-self-hosted == 'true' && runner.os == 'Windows'
        run: |
          echo "Setting up Android SDK for self-hosted Windows runner..."
          $ANDROID_SDK = "$env:LOCALAPPDATA\Android\Sdk"
          if (Test-Path $ANDROID_SDK) {
            echo "ANDROID_HOME=$ANDROID_SDK" >> $env:GITHUB_ENV
            echo "ANDROID_SDK_ROOT=$ANDROID_SDK" >> $env:GITHUB_ENV
            echo "$ANDROID_SDK\platform-tools" >> $env:GITHUB_PATH
            echo "$ANDROID_SDK\cmdline-tools\latest\bin" >> $env:GITHUB_PATH
            echo "✅ Android SDK found at: $ANDROID_SDK"
          } else {
            echo "❌ Android SDK not found at: $ANDROID_SDK"
            exit 1
          }
        shell: powershell

      - name: Grant execute permission for gradlew
        if: runner.os != 'Windows'
        run: chmod +x gradlew
        shell: bash

      - name: Run Paparazzi screenshot tests
        run: ./gradlew verifyPaparazziDebug --continue || true
        shell: bash

      - name: Upload screenshot test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshot-test-results
          path: app/build/reports/paparazzi/
          retention-days: 14

  dependency-updates:
    name: Dependency Updates Check
    runs-on: ubuntu-latest  # Lightweight - always use GitHub runner
    # Only run on schedule or manual trigger, not on every push
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Check for dependency updates
        run: ./gradlew dependencyUpdates

      - name: Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-updates-report
          path: build/reports/dependencyUpdates/
          retention-days: 30
